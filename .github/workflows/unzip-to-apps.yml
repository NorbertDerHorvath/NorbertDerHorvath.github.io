name: Unzip ZIPs into /apps (no index overwrite)

on:
  push:
    paths:
      - "zips/**/*.zip"
      - ".github/workflows/unzip-to-apps.yml"

permissions:
  contents: write

jobs:
  unzip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip rsync

      - name: Unzip all ZIPs into /apps
        run: |
          set -euo pipefail
          mkdir -p apps /tmp/unzip
          shopt -s nullglob

          for z in zips/**/*.zip zips/*.zip; do
            echo "==> Processing: $z"
            app="$(basename "$z" .zip)"

            rm -rf /tmp/unzip/*
            unzip -q "$z" -d /tmp/unzip

            src="/tmp/unzip"
            if [ -f /tmp/unzip/dist/index.html ]; then
              src="/tmp/unzip/dist"
            fi

            if [ ! -f "$src/index.html" ]; then
              echo "❌ ERROR: index.html hiányzik a ZIP-ben: $z"
              exit 1
            fi

            rm -rf "apps/$app"
            mkdir -p "apps/$app"
            rsync -a --delete "$src"/ "apps/$app"/
            echo "✅ Updated: apps/$app"
          done

          touch .nojekyll

      - name: Commit & push changes (if any)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "Auto unzip ZIPs to /apps (keep custom index.html)"
            git push
          else
            echo "No changes."
          fi
